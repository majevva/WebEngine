name: Psalm Security Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '22 13 * * 5'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  php-security:
    name: Psalm Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, gd, curl, openssl, mbstring, dom, xml
          coverage: none
          tools: composer

      # POPRAWIONY KROK: Obsługa braku composer.json
      - name: Install Dependencies & Psalm
        run: |
          # Sprawdzamy czy istnieje composer.json
          if [ -f "composer.json" ]; then
            echo "Znaleziono composer.json. Instaluje zaleznosci..."
            composer install --prefer-dist --no-progress
          else
            echo "Nie znaleziono composer.json. Inicjalizuje tymczasowe srodowisko..."
            # Tworzymy pusty plik composer.json tylko po to, by móc zainstalować Psalm
            composer init --name="security/scan" --type=project --require="php:>=8.1" -n
          fi
          
          # Instalujemy Psalm (skaner) niezależnie od struktury projektu
          composer require --dev vimeo/psalm

      - name: Init Psalm config
        run: |
          if [ ! -f psalm.xml ]; then
            vendor/bin/psalm --init
            # Ustawiamy poziom błędów i włączamy analizę bezpieczeństwa
            sed -i 's/<psalm/<psalm errorLevel="3"/' psalm.xml
            # Dodajemy ignorowanie folderu vendor, żeby nie skanował bibliotek skanera
            sed -i 's/<directory name="." \/>/<directory name="." \/><ignoreFiles><directory name="vendor" \/><\/ignoreFiles>/' psalm.xml
          fi

      - name: Run Psalm Security Scan
        # Uruchamiamy skanowanie
        run: vendor/bin/psalm --report=results.sarif --taint-analysis --no-cache
        continue-on-error: true

      - name: Upload Security Analysis results to GitHub
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: results.sarif
