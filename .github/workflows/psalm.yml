name: Psalm Security Scan

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]
  schedule:
    - cron: '22 13 * * 5'
  workflow_dispatch:

permissions:
  contents: read

jobs:
  php-security:
    name: Psalm Analysis
    runs-on: ubuntu-latest
    permissions:
      contents: read
      security-events: write
      actions: read

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.1'
          extensions: pdo, gd, curl, openssl, mbstring, dom, xml
          coverage: none
          tools: composer

      - name: Install Dependencies & Psalm
        run: |
          if [ -f "composer.json" ]; then
            echo "Znaleziono composer.json. Instaluje zaleznosci..."
            composer install --prefer-dist --no-progress
          else
            echo "Nie znaleziono composer.json. Inicjalizuje tymczasowe srodowisko..."
            composer init --name="security/scan" --type=project --require="php:>=8.1" -n
          fi
          composer require --dev vimeo/psalm

      # NAPRAWA: Zamiast edytować plik, tworzymy go od zera z poprawną treścią
      - name: Create Psalm config
        run: |
          cat <<EOF > psalm.xml
          <?xml version="1.0"?>
          <psalm
              errorLevel="3"
              resolveFromConfigFile="true"
              xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
              xmlns="https://getpsalm.org/schema/config"
              xsi:schemaLocation="https://getpsalm.org/schema/config vendor/vimeo/psalm/config.xsd"
              findUnusedCode="false"
          >
              <projectFiles>
                  <directory name="." />
                  <ignoreFiles>
                      <directory name="vendor" />
                  </ignoreFiles>
              </projectFiles>
              <enableExtensions>
                  <extension name="taint" />
              </enableExtensions>
          </psalm>
          EOF

      - name: Run Psalm Security Scan
        run: vendor/bin/psalm --report=results.sarif --taint-analysis --no-cache
        continue-on-error: true

      - name: Upload Security Analysis results to GitHub
        # Zaktualizowałem wersję akcji do v4, bo v3 wkrótce wygasa
        uses: github/codeql-action/upload-sarif@v4
        with:
          sarif_file: results.sarif
